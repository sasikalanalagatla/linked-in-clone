<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Applied Jobs</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease-in-out;
        }
        .pagination {
            justify-content: center;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-briefcase me-2"></i>My Applied Jobs</h2>
                <a th:href="@{/job/feed}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Job Feed
                </a>
            </div>

            <!-- Sorting Form -->
            <div class="mb-4">
                <form th:action="@{/job/applied}" method="get">
                    <div class="row g-2 align-items-center">
                        <div class="col-auto">
                            <label for="sortBy" class="form-label me-2">Sort by:</label>
                        </div>
                        <div class="col-auto">
                            <select name="sortBy" id="sortBy" class="form-select">
                                <option value="appliedAt" th:selected="${sortBy == 'appliedAt'}">Application Date</option>
                                <option value="job.jobTitle" th:selected="${sortBy == 'job.jobTitle'}">Job Title</option>
                                <option value="job.company.name" th:selected="${sortBy == 'job.company.name'}">Company</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <select name="sortDir" class="form-select">
                                <option value="desc" th:selected="${sortDir == 'desc'}">Descending</option>
                                <option value="asc" th:selected="${sortDir == 'asc'}">Ascending</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <input type="hidden" name="size" th:value="${size}"/>
                            <button type="submit" class="btn btn-primary">Apply Sort</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Empty State -->
            <div th:if="${appliedJobs.empty}" class="alert alert-info text-center">
                <i class="fas fa-info-circle me-2"></i>
                You haven't applied to any jobs yet.
                <br>
                <a th:href="@{/job/feed}" class="btn btn-primary mt-2">Browse Jobs</a>
            </div>

            <!-- Applied Jobs List -->
            <div th:unless="${appliedJobs.empty}">
                <div class="mb-3">
                      <span class="badge bg-primary fs-6">
                          Total Applications: <span th:text="${totalElements}"></span>
                      </span>
                </div>

                <div class="row">
                    <div class="col-12" th:each="jobApplication : ${appliedJobs}">
                        <div class="card mb-3 shadow-sm">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h5 class="card-title">
                                            <a th:href="@{'/job/get/' + ${jobApplication.job.id}}"
                                               class="text-decoration-none">
                                                <span th:text="${jobApplication.job.jobTitle}"></span>
                                            </a>
                                        </h5>
                                        <h6 class="card-subtitle mb-2 text-muted">
                                            <i class="fas fa-building me-1"></i>
                                            <a th:href="@{'/company/' + ${jobApplication.job.company.id}}"
                                               class="text-muted text-decoration-none"
                                               th:text="${jobApplication.job.company.name}"></a>
                                        </h6>
                                        <p class="card-text">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            <span th:text="${jobApplication.job.jobLocation}"></span>
                                            <span class="ms-3">
                                                  <i class="fas fa-clock me-1"></i>
                                                  <span th:text="${jobApplication.job.jobTypes?.toString()}"></span>
                                              </span>
                                            <span class="ms-3">
                                                  <i class="fas fa-home me-1"></i>
                                                  <span th:text="${jobApplication.job.jobWorkPlaceTypes?.toString()}"></span>
                                              </span>
                                        </p>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                Applied on: <span th:text="${#temporals.format(jobApplication.appliedAt, 'MMM dd, yyyy HH:mm')}"></span>
                                            </small>
                                        </p>
                                    </div>
                                    <div class="col-md-4 d-flex flex-column justify-content-between">
                                        <div class="mb-2">
                                            <span class="badge bg-success">Applied</span>
                                        </div>
                                        <div>
                                            <a th:href="${jobApplication.resumeUrl}"
                                               target="_blank"
                                               class="btn btn-sm btn-outline-primary mb-2 w-100"
                                               th:if="${jobApplication.resumeUrl}">
                                                <i class="fas fa-file-pdf me-1"></i>View Resume
                                            </a>
                                            <a th:href="@{'/job/get/' + ${jobApplication.job.id}}"
                                               class="btn btn-sm btn-primary w-100">
                                                <i class="fas fa-eye me-1"></i>View Job
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- Additional Questions and Answers -->
                                <div th:if="${!jobApplication.additionalQuestionAnswers.empty}" class="mt-3">
                                    <h6 class="text-muted">Additional Information:</h6>
                                    <div class="row">
                                        <div class="col-12"
                                             th:each="answer, iterStat : ${jobApplication.additionalQuestionAnswers}"
                                             th:if="${answer != null and !answer.isEmpty()}">
                                            <div class="mb-2">
                                                <strong th:text="${jobApplication.job.additionalQuestions[iterStat.index].questionText}"></strong>
                                                <p class="mb-1 text-muted" th:text="${answer}"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pagination Controls -->
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination">
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/job/applied(page=${currentPage - 1}, size=${size}, sortBy=${sortBy}, sortDir=${sortDir})}"
                               th:if="${currentPage > 0}">
                                Previous
                            </a>
                        </li>
                        <li class="page-item disabled">
                              <span class="page-link">
                                  Page <span th:text="${currentPage + 1}"></span> of <span th:text="${totalPages}"></span>
                              </span>
                        </li>
                        <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/job/applied(page=${currentPage + 1}, size=${size}, sortBy=${sortBy}, sortDir=${sortDir})}"
                               th:if="${currentPage + 1 < totalPages}">
                                Next
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>
</html>